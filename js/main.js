(function(){$.fn.times=function(a){var b,c,d,e;c=$(this)[0],e=[];for(b=d=0;0<=c?d<c:d>c;b=0<=c?++d:--d)e.push(a(b));return e},$.fn.times_map=function(a){var b;return b=[],$(this).times(function(c){return b.push(a(c))}),b},$.fn.random_element=function(a){var b,c;return b=$(this),c=Math.floor(Math.random()*b.length),this[c]},$.fn.all=function(a){var b;return b=!0,this.each(function(){if(!a(this,this))return b=!1,!1}),b},$.fn.any=function(a){var b;return b=!1,this.each(function(){if(!!a(this,this))return b=!0,!1}),b}}).call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function b(){this.key_down=c(this.key_down,this),this.elem=window,this.target=null,$(this.elem).keydown(this.key_down)}var a;return a={27:"esc",37:"left",38:"up",39:"right",40:"down",32:"space",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",96:"num0",97:"num1",98:"num2",99:"num3",100:"num4",101:"num5",102:"num6",103:"num7",104:"num8",105:"num9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},b.prototype.set_target=function(a){return this.target=a},b.prototype.clear_target=function(){return this.target=null},b.prototype.key_down=function(b){var c,d;if(!this.target)return;d=a[b.which];if(!d)return;return c={shift:b.shiftKey,ctrl:b.ctrlKey},this.target.on_key(d,c)},b}(),b.Keyboard=a}.call(this),function(){var a,b,c,d,e,f,g;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.actor=a,this.state=b}return a}(),b=[],c={},f=function(a){var d;return d=new a,b.push(d),c[d.key]=d},e=function(){return b},d=function(a){return c[a]},g.Alignment=a,g.register_alignment=f,g.list_alignments=e,g.get_alignment=d}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="evil",b}(Alignment),register_alignment(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="good",b}(Alignment),register_alignment(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="neutral",b}(Alignment),register_alignment(a)}.call(this),function(){var a,b,c,d,e,f,g;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b=[],c={},f=function(a){var c;return c=new a,b.push(c),b[c.key]=c},e=function(){return b},d=function(a){return c[a]},g.Gender=a,g.register_gender=f,g.list_genders=e,g.get_gender=d}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="male",b.prototype.name="male",b.prototype.base_hp=4,b.prototype.base_mp=0,b.prototype.base_speed=0,b.prototype.base_attack=3,b}(Gender),register_gender(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="female",b.prototype.name="female",b.prototype.base_hp=0,b.prototype.base_mp=5,b.prototype.base_speed=-20,b.prototype.base_attack=0,b}(Gender),register_gender(a)}.call(this),function(){var a,b,c,d,e,f,g,h;h=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),e=[],f={},g=function(a){var b;return b=new a,e.push(b),f[b.key]=b},c=function(){return e},d=function(a){return _.filter(e,function(b){return _.contains(b.alignments,a)})},b=function(a){return f[a]},h.Race=a,h.register_race=g,h.list_races=c,h.list_races_for_alignment=d,h.get_race=b}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="angel",b.prototype.name="angel",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=28,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race),register_race(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="catfolk",b.prototype.name="catfolk",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="centaur",b.prototype.name="centaur",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="demon",b.prototype.name="demon",b.prototype.alignments=["evil"],b.prototype.base_hp=25,b.prototype.base_mp=15,b.prototype.base_speed=120,b.prototype.base_attack=12,b.prototype.skills=[],b}(Race),register_race(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="dragon",b.prototype.name="dragon",b.prototype.alignments=["good","neutral","evil"],b.prototype.base_hp=40,b.prototype.base_mp=20,b.prototype.base_speed=175,b.prototype.base_attack=15,b.prototype.skills=[],b}(Race),register_race(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="dragonkin",b.prototype.name="dragonkin",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="dwarf",b.prototype.name="dwarf",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="elf",b.prototype.name="elf",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="giant",b.prototype.name="giant",b.prototype.alignments=["good","neutral"],b.prototype.base_hp=30,b.prototype.base_mp=10,b.prototype.base_speed=130,b.prototype.base_attack=11,b.prototype.skills=[],b}(Race),register_race(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="gnome",b.prototype.name="gnome",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="hobbit",b.prototype.name="hobbit",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="human",b.prototype.name="human",b.prototype.alignments=["good","neutral","evil"],b.prototype.base_hp=20,b.prototype.base_mp=20,b.prototype.base_speed=100,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race),register_race(a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="shapeshifter",b.prototype.name="shapeshifter",b.prototype.alignments=["good"],b.prototype.base_hp=10,b.prototype.base_mp=30,b.prototype.base_speed=80,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="vampire",b.prototype.name="vampire",b.prototype.alignments=["evil"],b.prototype.base_hp=15,b.prototype.base_mp=15,b.prototype.base_speed=100,b.prototype.base_attack=15,b.prototype.skills=[],b}(Race)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.key="werewolf",b.prototype.name="werewolf",b.prototype.alignments=["neutral","evil"],b.prototype.base_hp=20,b.prototype.base_mp=20,b.prototype.base_speed=100,b.prototype.base_attack=10,b.prototype.skills=[],b}(Race),register_race(a)}.call(this),function(){var a,b,c,d,e,f,g,h;h=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b=[],c={},g=function(a){var d;return d=new a,b.push(d),c[d.key]=d},e=function(){return b},f=function(a,c){return _.filter(b,function(b){return _.contains(b.alignments,a)&&_.contains(b.races,c)})},d=function(a){return c[a]},h.Class=a,h.register_class=g,h.list_classes=e,h.list_classes_for_alignment_and_race=f,h.get_class=d}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="beastmaster",a.prototype.name="beastmaster",a.prototype.genders=list_genders(),a.prototype.alignments=list_alignments(),a.prototype.races=list_races(),a.prototype.base_hp=3,a.prototype.base_mp=3,a.prototype.base_speed=20,a.prototype.base_attack=20,a.prototype.skills=[],a}()}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="druid",a.prototype.name="druid",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral"],a.prototype.races=["human","werewolf","dragon","giant","angel"],a.prototype.base_hp=-5,a.prototype.base_mp=5,a.prototype.base_speed=20,a.prototype.base_attack=-2,a.prototype.skills=["tree_form","bark_skin","iron_claws","summon_wolf","feline_grace","innervate","healing_touch","fox_fire","entangle","bear_strength"],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="fighter",a.prototype.name="fighter",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral","evil"],a.prototype.races=["human","giant","angel"],a.prototype.base_hp=5,a.prototype.base_mp=5,a.prototype.base_speed=0,a.prototype.base_attack=0,a.prototype.skills=[],a}()}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="healer",a.prototype.name="healer",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral"],a.prototype.races=["human","werewolf","dragon","giant","angel"],a.prototype.base_hp=-5,a.prototype.base_mp=5,a.prototype.base_speed=20,a.prototype.base_attack=-2,a.prototype.skills=["poultice","healing_kit","healing_aura",""],a}()}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="hunter",a.prototype.name="hunter",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral","evil"],a.prototype.races=["human","giant","angel"],a.prototype.base_hp=5,a.prototype.base_mp=5,a.prototype.base_speed=0,a.prototype.base_attack=0,a.prototype.skills=[],a}()}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="necromancer",a.prototype.name="necromancer",a.prototype.genders=["male","female"],a.prototype.alignments=["evil"],a.prototype.races=["human","werewolf","dragon","demon"],a.prototype.base_hp=-10,a.prototype.base_mp=26,a.prototype.base_speed=20,a.prototype.base_attack=-5,a.prototype.skills=["summon_skeletons","drain_life","death_shroud","terrify","rot","mark_of_death","dominate","plague","consume","curse"],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="paladin",a.prototype.name="paladin",a.prototype.genders=["male","female"],a.prototype.alignments=["good"],a.prototype.races=["human","giant","angel"],a.prototype.base_hp=10,a.prototype.base_mp=0,a.prototype.base_speed=-20,a.prototype.base_attack=4,a.prototype.skills=["healing_aura","smite","shield_bash","divine_shield","retribution","blessing","sanctuary","beacon_of_light","blinding_light","healing_touch"],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="ranger",a.prototype.name="ranger",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral","evil"],a.prototype.races=["human","giant","angel"],a.prototype.base_hp=5,a.prototype.base_mp=5,a.prototype.base_speed=0,a.prototype.base_attack=0,a.prototype.skills=[],a}()}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="rogue",a.prototype.name="rogue",a.prototype.genders=["male","female"],a.prototype.alignments=["neutral","evil"],a.prototype.races=["human","werewolf","demon"],a.prototype.base_hp=-5,a.prototype.base_mp=-10,a.prototype.base_speed=75,a.prototype.base_attack=5,a.prototype.skills=["stealth","double_strike","apply_poison","counterattack","evade","distract","fan_of_knives","shadowstep","steal","preparation"],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="warrior",a.prototype.name="warrior",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral","evil"],a.prototype.races=["human","werewolf","dragon","giant","angel","demon"],a.prototype.base_hp=10,a.prototype.base_mp=-10,a.prototype.base_speed=5,a.prototype.base_attack=2,a.prototype.skills=["whirlwind_strike","cleave","berserk","charge","bash","heavy_strike","skull_crack","savage_leap","adrenaline","cripple"],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="wizard",a.prototype.name="wizard",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral","evil"],a.prototype.races=["human","dragon","angel","demon"],a.prototype.base_hp=-5,a.prototype.base_mp=25,a.prototype.base_speed=-20,a.prototype.base_attack=-3,a.prototype.skills=["fireball","wind_slash","force_push","teleport","ice_wall","magic_missiles","polymorph","nova","meditate","barrier"],a}(),register_class(a)}.call(this),function(){var a,b,c,d,e,f,g,h=[].slice;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c){this.duration=a,this.id=b,this.state=c}return a.prototype.active=function(){return this.duration>0},a.prototype.start=function(){return this.on_start()},a.prototype.end=function(){return this.on_end()},a.prototype.run=function(){this.duration-=1,this.on_run();if(this.duration<=0)return this.on_end()},a.prototype.on_start=function(){},a.prototype.on_end=function(){},a.prototype.on_run=function(){},a.prototype.execute_action=function(){var a,b,c,d;return d=arguments[0],c=2<=arguments.length?h.call(arguments,1):[],a=get_action(d),b=new a(this.id,this.state),b.run.apply(b,c)},a}(),b=[],c={},f=function(a,d){var e;return e=d,b.push(e),c[a]=e},e=function(){return b},d=function(a){return c[a]},g.Geas=a,g.register_geas=f,g.list_geass=e,g.get_geas=d}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.on_start=function(){return this.state.msg(this.id,"You descend into a berzerk rage.")},b.prototype.on_run=function(){var a,b,c,d,e,f,g;a=this.state.get_adjacent_positions(this.id),d=[],_.each(a,function(a){return function(b){var c;if((c=a.state).is_creature.apply(c,b))return d.push(b)}}(this));if(d.length>0)return g=$(d).random_element(),e=g[0],f=g[1],c=this.state.general_direction(this.id,e,f),this.execute_action("attack",c,{mod:2,flavor:"obliterate"});b=this.state.get_closest_creature(this.id,{range:6});if(b)return c=this.state.general_direction(this.id,this.state.get_pos(b)),this.execute_action("move",c)},b.prototype.on_end=function(){return this.state.msg(this.id,"The berserk rage lapses.")},b}(Geas),register_geas("berserk",a)}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=[].slice;m=typeof exports!="undefined"&&exports!==null?exports:this,f=0,c=1,b=2,d=3,g=4,e=5,a=function(){function a(a,b){this.id=a,this.state=b}return a.prototype.target=f,a.prototype.add_geas=function(a,b,c){var d,e,f;return d=get_geas(c),f=new d(b,a,this.state),e=this.state.get_actor(a),e.add_geas(f)},a.prototype.execute_action=function(){var b,c,d;return d=arguments[0],c=2<=arguments.length?n.call(arguments,1):[],a=j(d),b=new a(this.id,this.state),b.run.apply(b,c)},a}(),h=[],i={},l=function(a,b){var c;return c=b,h.push(c),i[a]=c},k=function(){return h},j=function(a){return i[a]},m.Action=a,m.register_action=l,m.list_actions=k,m.get_action=j,m.TARGET_NONE=f,m.TARGET_DIR8=c,m.TARGET_DIR4=b,m.TARGET_FOV=d,m.TARGET_RANGE=g,m.TARGET_MENU=e}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.run=function(a,b){var c,d,e,f,g,h,i;b==null&&(b={}),b.mod==null&&(b.mod=1),b.flavor==null&&(b.flavor="attack"),i=this.state.get_adjacent_pos(this.id,a),e=i[0],f=i[1],d=this.state.get_attack(this.id),d=Math.round(d*b.mod),g=this.state.get_by_pos(e,f);if(g)return c=this.state.get_short_description(this.id),h=this.state.get_short_description(g),this.state.msg(this.id,"You "+b.flavor+" "+h+"."),this.state.msg(g,""+_.str.capitalize(c)+" "+b.flavor+"s you!"),this.state.damage(g,d),this.state.is_dead(g)&&(this.state.msg(this.id,"You killed "+h+"!"),this.state.msg(g,"You are dead!"),this.state.remove(g)),!0},b}(Action),register_action("attack",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.run=function(a){var b,c,d;return d=this.state.get_adjacent_pos(this.id,a),b=d[0],c=d[1],this.state.is_blocked(b,c)?(this.state.msg(this.id,"You can't go that way."),!1):(this.state.set_pos(this.id,b,c),this.state.set_off_triggers(this.id),!0)},b}(Action),register_action("move",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.run=function(a,b){var c,d,e;return b==null&&(b={}),e=this.state.get_adjacent_pos(this.id,a),c=e[0],d=e[1],this.state.is_creature(c,d)?this.execute_action("attack",a,b):this.execute_action("move",a)},b}(Action),register_action("move_or_attack",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_NONE,b.prototype.run=function(){return!0},b}(Action),register_action("wait",a)}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o={}.hasOwnProperty,p=function(a,b){function d(){this.constructor=a}for(var c in b)o.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};l=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return p(b,a),b}(Action),m=[],n={},k=function(a,b){var c;return c=b,m.push(c),n[a]=c},g=function(){return m},f=function(){var a;return a=[],_.each(m,function(b){var c;return c=new b,a.push(c.key)}),a},c=function(a){return n[a]},h=[],i={},j=function(a,b){var c;return c=b,h.push(c),i[a]=c},e=function(){return h},d=function(){var a;return a=[],_.each(h,function(b){var c;return c=new b,a.push(c.key)}),a},b=function(a){return i[a]},l.Skill=a,l.register_skill=k,l.list_skills=g,l.list_skill_keys=f,l.get_skill=c,l.register_monster_skill=j,l.list_monster_skills=e,l.list_monster_skill_keys=d,l.get_monster_skill=b}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_NONE,b.prototype.key="adrenaline",b.prototype.name="adrenaline",b.prototype.mp=8,b.prototype.cooldown=15,b.prototype.run=function(a){return!0},b}(Skill)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.key="bash",b.prototype.name="bash",b.prototype.mp=3,b.prototype.cooldown=2,b.prototype.run=function(a){var b,c,d,e,f,g,h,i;h=this.state.get_adjacent_pos(this.id,a),b=h[0],c=h[1],g=this.state.get_by_pos(b,c);if(!g)return;return i=this.state.get_adjacent(b,c,a),d=i[0],e=i[1],this.state.is_blocked(d,e)?(this.execute_action("attack",a,{mod:1.4,flavor:"bash"}),f=this.state.get_by_pos(d,e),f&&(this.state.damage(f,this.state.get_attack(this.id)*.2),this.state.msg(f,"Something bashes into you."))):(this.execute_action("attack",a,{mod:.8,flavor:"push"}),this.state.exists(g)&&this.state.set_pos(g,d,e),this.state.set_pos(this.id,b,c)),!0},b}(Skill),register_skill("bash",a),register_monster_skill("bash",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_NONE,b.prototype.key="berserk",b.prototype.name="berserk",b.prototype.mp=15,b.prototype.cooldown=10,b.prototype.run=function(a){return this.add_geas(this.id,5,"berserk")},b}(Skill),register_skill("berserk",a),register_monster_skill("berserk",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.key="charge",b.prototype.name="charge",b.prototype.mp=8,b.prototype.cooldown=5,b.prototype.run=function(a){var b,c,d,e,f,g,h;return g=this.state.get_pos(this.id),c=g[0],d=g[1],h=this.state.find_in_direction(c,d,a,function(b){return function(c,d,e){return b.state.is_blocked_in_dir(c,d,a)||e>=6}}(this)),e=h[0],f=h[1],e===c&&f===d?!1:(b=this.state.get_short_description(this.id),this.state.msg(this.id,"You shout wildly and charge!"),this.state.shout_by(this.id,""+_.str.capitalize(b)+" shouts wildly and charges!"),this.state.set_pos(this.id,e,f),this.execute_action("attack",a),!0)},b}(Skill),register_skill("charge",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.key="cleave",b.prototype.name="cleave",b.prototype.mp=4,b.prototype.cooldown=4,b.prototype.run=function(a){var b,c,d,e;return c=[a,this.state.rotate_right(a),this.state.rotate_left(a)],d=[],$.each(c,function(a){return function(b,c){return d.push(a.state.get_adjacent_pos(a.id,c))}}(this)),b=this.state.get_attack(this.id),b=Math.ceil(b*.5),e=!1,$.each(d,function(a){return function(c,d){var f,g,h,i,j;i=d[0],j=d[1],g=a.state.get_by_pos(i,j);if(g)return f=a.state.get_short_description(a.id),h=a.state.get_short_description(g),a.state.msg(a.id,"You cleave "+h+"."),a.state.msg(g,""+_.str.capitalize(f)+"'s cleaves you!"),a.state.damage(g,b),a.state.is_dead(g)&&(a.state.msg(a.id,"You killed "+h+"!"),a.state.msg(g,"You are dead!"),a.state.remove(g)),e=!0}}(this)),e},b}(Skill),register_skill("cleave",a),register_monster_skill("cleave",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.key="cripple",b.prototype.name="cripple",b.prototype.mp=0,b.prototype.cooldown=10,b.prototype.run=function(a){return!0},b}(Skill)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.key="heavy_strike",b.prototype.name="heavy strike",b.prototype.mp=5,b.prototype.cooldown=5,b.prototype.run=function(a){return this.execute_action("attack",a,{mod:1.5,flavor:"demolish"})},b}(Skill),register_skill("heavy_strike",a),register_monster_skill("heavy_strike",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a},d=[].slice;a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.key="savage_leap",b.prototype.name="savage leap",b.prototype.mp=5,b.prototype.cooldown=10,b.prototype.run=function(a){var b,c,e,f,g,h,i,j,k;j=this.state.get_pos(this.id),f=j[0],g=j[1],k=this.state.pos_in_direction(f,g,a,3),h=k[0],i=k[1];if(this.state.is_blocked(h,i))return;c=this.state.get_all_adjacent_pos(h,i),e=[],_.each(c,function(a){return function(b){var c;if((c=a.state).is_creature.apply(c,b))return e.push(b)}}(this));if(e.length===0)return;return b=this.state.get_short_description(this.id),this.state.msg(this.id,"You leap into the fray!"),this.state.shout_by(this.id,""+_.str.capitalize(b)+" leaps into the fray!"),this.state.set_pos(this.id,h,i),_.each(e,function(b){return function(c){var e;return a=(e=b.state).general_direction.apply(e,[b.id].concat(d.call(c))),b.execute_action("attack",a,{mod:.2,flavor:"stomp"})}}(this)),!0},b}(Skill),register_skill("savage_leap",a)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_DIR8,b.prototype.key="skull_crack",b.prototype.name="skull crack",b.prototype.mp=3,b.prototype.cooldown=3,b.prototype.run=function(a){return!0},b}(Skill)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.target=TARGET_NONE,b.prototype.key="whirlwind_strike",b.prototype.name="whirlwind strike",b.prototype.mp=10,b.prototype.cooldown=5,b.prototype.run=function(){var a,b;return b=this.state.get_adjacent_positions(this.id),a=this.state.get_attack(this.id),a=Math.ceil(a*.25),$.each(b,function(b){return function(c,d){var e,f,g,h,i;h=d[0],i=d[1],f=b.state.get_by_pos(h,i);if(f)return e=b.state.get_short_description(b.id),g=b.state.get_short_description(f),b.state.msg(b.id,"You hit "+g+"."),b.state.msg(f,""+_.str.capitalize(e)+"'s whirlwind strike hits you!"),b.state.damage(f,a),b.state.is_dead(f)&&(b.state.msg(b.id,"You killed "+g+"!"),b.state.msg(f,"You are dead!"),b.state.remove(f)),!0}}(this))},b}(Skill),register_skill("whirlwind_strike",a),register_monster_skill("whirlwind_strike",a)}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){a==null&&(a={}),this.id=a.id,this.x=a.x,this.y=a.y,this.level=a.level,this.xp=0,this.rarity=a.rarity,this.alignment=a.alignment,this.gender=a.gender,this.race=a.race,this["class"]=a["class"],this.base_attack=a.base_attack,this.attack=this.base_attack,this.base_speed=a.base_speed,this.speed=this.base_speed,this.base_hp=a.base_hp,this.max_hp=this.base_hp,this.hp=this.max_hp,this.base_mp=a.base_mp,this.max_mp=this.base_mp,this.mp=this.max_mp,this.short_description="a "+this.race.name+" "+this["class"].name,this.dead=a.dead,this.skills=[],this._add_skills(a.skills)}return a.prototype.pos=function(){return[this.x,this.y]},a.prototype.set_pos=function(a,b){this.x=a,this.y=b},a.prototype.level_up=function(){var a;return this.level+=1,this.xp=0,a=this._level_up_stat("max_hp","base_hp"),this.hp+=a,a=this._level_up_stat("max_mp","base_hp"),this.mp+=a,this._level_up_stat("attack","base_attack"),this._level_up_speed()},a.prototype.add_skill=function(a){var b,c;b=get_skill(a);if(!b)throw new Error("Could not find skill with key: "+a);return c=new b(null,null),this.skills.push({key:a,name:c.name,mp:c.mp,base_cooldown:c.cooldown,cooldown_timer:0})},a.prototype._level_up_stat=function(a,b){var c;return c=Math.ceil(this[b]*.03333),this[a]+=c,c},a.prototype._level_up_speed=function(){return this.speed=Math.ceil(this.speed*.96667)},a.prototype._add_skills=function(a){return _.each(a,function(a){return function(b){return a.add_skill(b)}}(this))},a}(),b.Entity=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a.prototype.generate_id=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=Math.random()*16|0,c=a==="x"?b:b&3|8,c.toString(16)})},a}(),b.EntityGenerator=a}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.generate=function(a,b){var c,d,e,f,g,h,i,j,k,l;return c=$(list_alignments()).random_element(),h=$(list_genders()).random_element(),j=$(list_races_for_alignment(c.key)).random_element(),i=$(list_classes_for_alignment_and_race(c.key,j.key)).random_element(),k=function(){switch(a){case"trash":return.1;case"uncommon":return.2;case"rare":return.4}}(),k+=k*(b-1)*.2,d=h.base_attack+j.base_attack+i.base_attack,d=Math.ceil(d*k),e=h.base_hp+j.base_hp+i.base_hp,e=Math.ceil(e*k),f=h.base_mp+j.base_mp+i.base_mp,f=Math.ceil(f*k),g=h.base_speed+j.base_speed+i.base_speed,g=Math.ceil(g*Math.pow(.9,b-1)),l=$(list_monster_skill_keys()).random_element(),new Entity({id:this.generate_id(),x:0,y:0,level:1,gender:h,race:j,"class":i,base_attack:d,base_speed:g,base_hp:e,base_mp:f,dead:!1,rarity:a,skills:[l]})},b}(EntityGenerator),b.MonsterGenerator=a}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.generate=function(a,b,c){var d;return d=$(list_skill_keys()).random_element(),new Entity({id:this.generate_id(),x:0,y:0,level:1,gender:a,race:b,"class":c,base_attack:a.base_attack+b.base_attack+c.base_attack,base_speed:a.base_speed+b.base_speed+c.base_speed,base_hp:a.base_hp+b.base_hp+c.base_hp,base_mp:a.base_mp+b.base_mp+c.base_mp,dead:!1,rarity:"player",skills:[d]})},b}(EntityGenerator),b.PlayerGenerator=a}.call(this),function(){var a,b,c,d,e,f,g,h=[].slice;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c){this.id=a,this.scheduler=b,this.state=c,this.acting=!1,this.removed=function(){},this.geas=null}return a.prototype.on_remove=function(a){return this.removed=a},a.prototype.act=function(){if(this.acting)throw new Error("Already acting!");this.acting=!0;if(this._removed_check()){this.removed();return}if(this.geas){this.run_geas(),this.after_geas_run();return}return this.on_act()},a.prototype.done=function(a){return a==null&&(a=this.state.get_speed(this.id)),this.scheduler.setDuration(a),this.acting=!1},a.prototype.add_geas=function(a){return this.geas=a,this.geas.start()},a.prototype.run_geas=function(){return this.geas.run(),this.geas.active()||(this.geas=null),this.done(),this.on_geas_done()},a.prototype.on_geas_done=function(){},a.prototype.after_geas_run=function(){},a.prototype.execute_action=function(){var a,b,c,d;return d=arguments[0],c=2<=arguments.length?h.call(arguments,1):[],a=get_action(d),b=new a(this.id,this.state),b.run.apply(b,c)},a.prototype._removed_check=function(){return!this.state.exists(this.id)},a}(),b=[],c={},f=function(a,d){var e;return e=d,b.push(e),c[a]=e},e=function(){return b},d=function(a){return c[a]},g.Actor=a,g.register_actor=f,g.list_actors=e,g.get_actor=d}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},e=[].slice;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(a,c,d,e){this.engine=d,b.__super__.constructor.call(this,a,c,e)}return d(b,a),b.prototype.on_act=function(){var a,b,c,d,f,g,h,i,j,k,l,m,n,o,p,q;return this.engine.lock(),j=this.state.player_id,this.state.exists(j)&&(m=this.state.get_pos(this.id),f=m[0],g=m[1],n=this.state.get_pos(j),k=n[0],l=n[1],b=Math.abs(k-f)+Math.abs(l-g),b>6?this._move_randomly():(i=new ROT.Path.AStar(k,l,function(a){return function(b,c){return!a.state.is_wall(b,c)}}(this)),h=[],o=this.state.get_pos(this.id),c=o[0],d=o[1],i.compute(c,d,function(a){return function(a,b){return h.push([a,b])}}(this)),h.length===2?(a=(p=this.state).general_direction.apply(p,[this.id].concat(e.call(h[1]))),Math.random()<.2?this._use_skill(a):this._move_or_attack(a)):h.length>2&&(a=(q=this.state).general_direction.apply(q,[this.id].concat(e.call(h[1]))),this._move(a)))),this.done(),this.engine.unlock()},b.prototype._move_randomly=function(){var a;return a=$(["n","ne","e","se","s","sw","w","nw"]).random_element(),this._move(a)},b.prototype._use_skill=function(a){var b,c,d,e;e=this.state.get_skills(this.id),d=$(e).random_element();if(!d)return;b=get_skill(d.key),c=new b(this.id,this.state);if(c.target===TARGET_DIR8)return c.run(a);if(c.target===TARGET_NONE)return c.run()},b.prototype._move_or_attack=function(a){return this.execute_action("move_or_attack",a)},b.prototype._move=function(a){return this.execute_action("move",a)},b}(Actor),register_actor("aggressive",a)}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(a,c,d,e,f){this.engine=d,this.on_update=f,b.__super__.constructor.call(this,a,c,e)}return d(b,a),b.prototype.on_act=function(){return this.engine.lock(),this.on_update(),this.accept_input=!0},b.prototype.on_key=function(a,b){var c;if(!this.acting)return;c=!1;if(a==="escape")return this.target_mode&&this.state.msg(this.id,"Nevermind."),this._clear_target(),!1;!this.target_mode||this.target_mode===TARGET_NONE?c=this._determine_action(a,b):this.target_mode===TARGET_DIR8?c=this._choose_dir8_and_run(a,b):this.target_mode===TARGET_DIR4?c=this._choose_dir4_and_run(a,b):this.target_mode===TARGET_FOV?c=this._choose_fov_and_run(a,b):this.target_mode===TARGET_RANGE?c=this._choose_range_and_run(a,b):this.target_mode===TARGET_MENU&&(c=this._choose_menu_and_run(a,b)),this.on_update();if(c)return this._end()},b.prototype._determine_action=function(a,b){var c,d,e,f,g,h,i,j,k,l;return f=this._get_direction(a,b),f?(c=get_action("move_or_attack"),d=new c(this.id,this.state),d.run(f)):(c=function(){switch(a){case"space":return get_action("wait");case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":return g=parseInt(a)-1,i=this.state.get_skills(this.id),h=i[g],h?c=get_skill(h.key):this.state.msg(this.id,"You don't have that skill yet.")}}.call(this),c?(d=new c(this.id,this.state),d.target===TARGET_NONE?(e=(k=d.cost)!=null?k:0,e>this.state.get_mp(this.id)?(this.state.msg(this.id,"You don't have enough mp."),!1):(j=d.run(),j&&this.state.remove_mp(this.id,e),j)):(this._send_target_message(d.target),this.target_mode=d.target,this.target_action=d,this.target_cost=(l=d.mp)!=null?l:0,!1)):!1)},b.prototype.on_geas_done=function(){return this.on_update()},b.prototype.after_geas_run=function(){return this.on_update()},b.prototype._choose_dir8_and_run=function(a,b){var c,d;c=this._get_direction(a,b);if(c)return this.target_cost>this.state.get_mp(this.id)?(this.state.msg(this.id,"You don't have enough mp."),this.target_mode&&this._clear_target(),!1):(d=this.target_action.run(c),d?this.state.remove_mp(this.id,this.target_cost):this.target_mode&&this.state.msg(this.id,"Nevermind."),this._clear_target(),d)},b.prototype._choose_dir4_and_run=function(a,b){var c;c=this._get_direction(a,b);if(c&&c.length===1)return this._choose_dir8_and_run(a,b)},b.prototype._choose_fov_and_run=function(a,b){},b.prototype._choose_range_and_run=function(a,b){},b.prototype._choose_menu_and_run=function(a,b){},b.prototype._send_target_message=function(a){switch(a){case TARGET_DIR8:return this.state.msg(this.id,"Use movement keys to choose any direction.");case TARGET_DIR4:return this.state.msg(this.id,"Use movement keys to choose one of the four main directions.");case TARGET_FOV:return this.state.msg(this.id,"Use movement keys to highlight an empty, visible square and press ENTER to confirm.");case TARGET_RANGE:return this.state.msg(this.id,"Use movement keys to any square in range.")}},b.prototype._clear_target=function(){return this.target_mode=null,this.target_action=null,this.target_cost=null},b.prototype._start=function(){return this.engine.lock()},b.prototype._end=function(a){return this.done(a),this.engine.unlock(),this.accept_input=!1},b.prototype._get_direction=function(a,b){var c;switch(a){case"up":case"k":case"num8":return c="n";case"u":case"num9":return c="ne";case"right":case"l":case"num6":return c="e";case"n":case"num3":return c="se";case"down":case"j":case"num2":return c="s";case"b":case"num1":return c="sw";case"left":case"h":case"num4":return c="w";case"y":case"num7":return c="nw"}},b}(Actor),register_actor("player",a)}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(a,c,d,e){this.engine=d,b.__super__.constructor.call(this,a,c,e)}return d(b,a),b.prototype.on_act=function(){return this.engine.lock(),this._move_or_attack(this._random_direction()),this.done(),this.engine.unlock()},b.prototype._random_direction=function(){return $(["n","ne","e","se","s","sw","w","nw"]).random_element()},b.prototype._move_or_attack=function(a){return this.execute_action("move_or_attack",a)},b}(Actor),register_actor("random",a)}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b.Help=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){a==null&&(a=[]),this.flags={},$(a).each(function(a){return function(b,c){return a.add_flag(c)}}(this))}return a.prototype.get_flags=function(){return $.map(this.flags,function(a,b){return b})},a.prototype.clear=function(){return this.flags={}},a.prototype.add_flag=function(a){return this.flags[a]=!0},a.prototype.has_flag=function(a){return this.flags.hasOwnProperty(a)},a}(),b.Tile=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c){this.width=a,this.height=b,this.num_layers=c,this.layers=[],$(this.num_layers).times(function(a){return function(b){return a.layers[b]=[],$(a.height).times(function(c){return a.layers[b][c]=Array(a.width),$(a.width).times(function(d){return a.layers[b][c][d]=null})})}}(this))}return a.prototype.each=function(a){return $(this.height).times(function(b){return function(c){return $(b.width).times(function(b){return a(c,b)})}}(this))},a.prototype.at=function(a,b,c,d){return this.get_tile(a,b,c)===d},a.prototype.exists=function(a,b,c){return this.get_tile(a,b,c)!==null},a.prototype.get_stack=function(a,b){return this.out_of_bounds(a,b)?[]:$(this.num_layers).times_map(function(c){return function(d){return c.get_tile(a,b,d)}}(this))},a.prototype.get_tile=function(a,b,c){if(this.out_of_bounds(a,b,c))return;return this.layers[c][a][b]},a.prototype.set_tile=function(a,b,c,d){if(this.out_of_bounds(a,b,c))return;return this.layers[c][a][b]=d},a.prototype.swap_tile=function(a,b,c,d,e){var f,g;return f=this.get_tile(a,b,e),g=this.get_tile(c,d,e),this.set_tile(c,d,e,f),this.set_tile(a,b,e,g)},a.prototype.clear_tile=function(a,b,c){return this.set_tile(a,b,c,null)},a.prototype.clear=function(){return $(this.num_layers).times(function(a){return function(b){return a.clear_layer(b)}}(this))},a.prototype.clear_layer=function(a){return $(this.height).times(function(b){return function(c){return $(b.width).times(function(d){return b.layers[a][c][d]=null})}}(this))},a.prototype.out_of_bounds=function(a,b,c){var d,e,f;return d=a&&a<0||a>=this.height,e=b&&b<0||b>=this.width,f=c&&c<0||c>=this.num_layers,d||e||f},a}(),b.Map=a}.call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function b(a,b){this.width=a,this.height=b,this.condition_two=c(this.condition_two,this),this.condition_one=c(this.condition_one,this)}var a;return a=.4,b.prototype.run=function(a){return this.build_floor(a),this.build_walls(a)},b.prototype.build_floor=function(a){return this.each(function(b,c){return a(b,c,FLOORS,"floor")})},b.prototype.build_walls=function(b){var c;return c=this.random_fill(a),$(5).times(function(a){return function(b){return c=a.step(c,a.condition_one)}}(this)),$(1).times(function(a){return function(b){return c=a.step(c,a.condition_two)}}(this)),c=this.connect_disjoint(c),this.each(function(a,d){if(c[a][d])return b(a,d,WALLS,"wall")})},b.prototype.blank_data=function(){var a;return a=[],$(this.height).times(function(b){return function(c){return a[c]=[],$(b.width).times(function(b){return a[c][b]=!1})}}(this)),a},b.prototype.copy_data=function(a){return this.map(function(b,c){return a[b][c]})},b.prototype.random_fill=function(a){return this.map(function(b,c){return Math.random()<a})},b.prototype.step=function(a,b){return this.map(function(c,d){return b(a,c,d)})},b.prototype.condition_one=function(a,b,c){return this.count_neighbors(a,b,c,1)>3||this.count_neighbors(a,b,c,2)<2},b.prototype.condition_two=function(a,b,c){return this.count_neighbors(a,b,c,1)>5},b.prototype.count_neighbors=function(a,b,c,d){var e;return e=0,this.each_neighbor(b,c,d,!0,function(b){return function(c,d){if(b.out_of_bounds(c,d)||a[c][d])return e+=1}}(this)),e},b.prototype.each_neighbor=function(a,b,c,d,e){var f,g,h,i,j,k;k=[];for(f=j=-c;-c<=c?j<=c:j>=c;f=-c<=c?++j:--j)k.push(function(){var j,k;k=[];for(g=j=-c;-c<=c?j<=c:j>=c;g=-c<=c?++j:--j)f!==0||g!==0?(h=a+f,i=b+g,d||this.in_bounds(h,i)?k.push(e(h,i)):k.push(void 0)):k.push(void 0);return k}.call(this));return k},b.prototype.in_bounds=function(a,b){return 0<=a&&a<this.height&&0<=b&&b<this.width},b.prototype.out_of_bounds=function(a,b){return!this.in_bounds(a,b)},b.prototype.connect_disjoint=function(a){var b,c,d,e,f;c=this.copy_data(a);for(;;){d=this.find_disjoint_regions(c);if(d.length<=1)break;b=d[0],f=d[1],e=d[2],c=this.connect_regions(c,b,f)}return c},b.prototype.find_disjoint_regions=function(a){var b,c,d,e,f,g;d=this.copy_data(a),f=[];for(;;){g=this.find_next_empty_space(d);if(!g)break;b=g[0],c=g[1],e=this.flood_fill(d,b,c),f.push(e),d=this.fill_in(d,e)}return f},b.prototype.find_next_empty_space=function(a){var b;return b=null,this.each(function(c){return function(c,d){if(!b&&!a[c][d])return b=[c,d]}}(this)),b},b.prototype.flood_fill=function(a,b,c){var d,e,f,g;f=[],e=new Heap(this.compare_coords),d=this.blank_data(),e.push([b,c]);while(!e.empty()){g=e.pop(),b=g[0],c=g[1];if(d[b][c])continue;d[b][c]=!0,f.push([b,c]),this.each_neighbor(b,c,1,!1,function(b){return function(b,c){if(!a[b][c]&&!d[b][c])return e.push([b,c])}}(this))}return f},b.prototype.fill_in=function(a,b){var c;return c=this.copy_data(a),$.each(b,function(a){return function(a,b){var d,e;return d=b[0],e=b[1],c[d][e]=!0}}(this)),c},b.prototype.compare_coords=function(a,b){var c,d,e,f;return c=a[0],e=a[1],d=b[0],f=b[1],c>d?-1:d===c?e>f?-1:e===f?0:1:1},b.prototype.connect_regions=function(a,b,c){var d,e;return d=$(b).random_element(),e=$(c).random_element(),this.dig_tunnel(a,d,e)},b.prototype.dig_tunnel=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p;f=this.copy_data(a);for(;;){g=b[0],k=b[1],h=c[0],l=c[1];if(g===h&&k===l)break;j=h-g,n=l-k,f=this.blast(f,g,k),Math.random()<.2?(o=this.choose_dir(.25,.25,.25),d=o[0],e=o[1]):(p=this.choose_dir(this.up_chance(j,n),this.right_chance(j,n),this.down_chance(j,n)),d=p[0],e=p[1]),i=g+d,m=k+e,this.out_of_bounds(i,m)||(b=[i,m])}return f},b.prototype.up_chance=function(a,b){return a>=0?0:Math.abs(a)/(Math.abs(b)+Math.abs(a))},b.prototype.right_chance=function(a,b){return b<=0?0:Math.abs(b)/(Math.abs(b)+Math.abs(a))},b.prototype.down_chance=function(a,b){return a<=0?0:Math.abs(a)/(Math.abs(b)+Math.abs(a))},b.prototype.left_chance=function(a,b){return b>=0?0:Math.abs(b)/(Math.abs(b)+Math.abs(a))},b.prototype.choose_dir=function(a,b,c){var d;return d=Math.random(),d<=a?[-1,0]:d<=a+b?[0,1]:d<=a+b+c?[1,0]:[0,-1]},b.prototype.cmp=function(a,b){return a<y1?-1:a===y1?0:1},b.prototype.blast=function(a,b,c){var d;return d=this.copy_data(a),d[b][c]=!1,this.each_neighbor(b,c,1,!1,function(a){return function(a,b){if(Math.random()<.2)return d[a][b]=!1}}(this)),d},b.prototype.each=function(a){return $(this.height).times(function(b){return function(c){return $(b.width).times(function(b){return a(c,b)})}}(this))},b.prototype.map=function(a){var b;return b=this.blank_data(),this.each(function(c,d){return b[c][d]=a(c,d)}),b},b}(),b.MapGenerator=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function b(a,b,c){this.title=a,this.cb=c,this.make_choices(b)}var a;return a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",b.prototype.make_choices=function(b){return this.choices=[],this.choice_map={},$.each(b,function(b){return function(c,d){return b.choices.push([a[c],d]),b.choice_map[a[c]]=d}}(this))},b.prototype.on_key=function(a,b){return b.shift&&(a=a.toUpperCase()),this.choose(a)},b.prototype.choose=function(a){if(this.choice_map[a])return this.cb(this.choice_map[a])},b}(),b.Menu=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){this.lines=a}return a}(),b.Output=a}.call(this),function(){var a,b,c,d,e,f,g,h,i,j;j=typeof exports!="undefined"&&exports!==null?exports:this,h=0,b=1,i=2,a=3,e=8,g={n:"ne",ne:"e",e:"se",se:"s",s:"sw",sw:"w",w:"nw",nw:"n"},d={n:"nw",ne:"n",e:"ne",se:"e",s:"se",sw:"s",w:"sw",nw:"w"},f={n:"s",ne:"sw",e:"w",se:"nw",s:"n",sw:"ne",w:"e",nw:"se"},c=function(){function c(a,b){this.map_width=a,this.map_height=b,this._map=new Map(this.map_width,this.map_height,4),this.floor=0,this._player_generator=new PlayerGenerator,this._monster_generator=new MonsterGenerator,this._cave_generator=new MapGenerator(this.map_width,this.map_height),this.clear_map(),this.exit_locked=!0,this._entities={},this.output=[],this.actors={}}return c.prototype.generate_player=function(a,b,c){return this._player=this._player_generator.generate(a,b,c),this.player_id=this._player.id,this._add(this._player)},c.prototype.generate_monster=function(a){var b;return b=this._monster_generator.generate(a,this.floor),this._add(b)},c.prototype.generate_cave=function(){return this.clear_map(),this._cave_generator.run(function(a){return function(b,c,d,e){return a._map.set_tile(b,c,d,e)}}(this))},c.prototype.next_floor=function(){return this.floor+=1},c.prototype.clear_map=function(){return this._map.clear()},c.prototype.clear_monsters=function(){return this.each_monster(function(a){return function(b){return a.remove(b)}}(this))},c.prototype.clear_output=function(){return this.output=[]},c.prototype.add_trigger=function(a,b,c){return this._map.set_tile(a,b,h,c)},c.prototype.get_trigger=function(a,b){return this._map.get_tile(a,b,h)},c.prototype.add_entrance=function(a,c){return this._map.set_tile(a,c,b,"entrance")},c.prototype.get_entrances=function(){return this._find_spaces(function(a){return function(b,c){return a.is_entrance(b,c)}}(this))},c.prototype.add_exit=function(a,c){return this._map.set_tile(a,c,b,"exit"),this.exit_locked=!0},c.prototype.get_exits=function(){return this._find_spaces(function(a){return function(b,c){return a.is_exit(b,c)}}(this))},c.prototype.register_actor=function(a,b){return this.actors[a]=b},c.prototype.unregister_actor=function(a){return delete this.actors[a]},c.prototype.get_actor=function(a){return this.actors[a]},c.prototype.each_creature=function(a){return $.each(this._entities,function(b){return function(b,c){return a(c.id)}}(this))},c.prototype.each_monster=function(a){return $.each(this._entities,function(b){return function(c,d){if(d.id!==b.player_id)return a(d.id)}}(this))},c.prototype.each_tile=function(a){return this._map.each(a)},c.prototype.exists=function(a){return!!this._entities[a]},c.prototype.get_pos=function(a){return this._entities[a].pos()},c.prototype.get_attack=function(a){return this._entities[a].attack},c.prototype.get_hp=function(a){return this._entities[a].hp},c.prototype.get_max_hp=function(a){return this._entities[a].max_hp},c.prototype.get_mp=function(a){return this._entities[a].mp},c.prototype.get_max_mp=function(a){return this._entities[a].max_mp},c.prototype.get_race=function(a){return this._entities[a].race},c.prototype.get_class=function(a){return this._entities[a]["class"]},c.prototype.get_gender=function(a){return this._entities[a].gender},c.prototype.get_speed=function(a){return this._entities[a].speed},c.prototype.get_level=function(a){return this._entities[a].level},c.prototype.get_short_description=function(a){return this._entities[a].short_description},c.prototype.get_skills=function(a){return this._entities[a].skills},c.prototype.at_max_hp=function(a){return this.get_hp(a)===this.get_max_hp(a)},c.prototype.at_max_mp=function(a){return this.get_mp(a)===this.get_max_mp(a)},c.prototype.is_dead=function(a){return this._entities[a].dead},c.prototype.is_blocked=function(a,b){return this.is_wall(a,b)||this.is_creature(a,b)},c.prototype.is_creature=function(b,c){return this._map.exists(b,c,a)},c.prototype.is_wall=function(a,b){return this._map.exists(a,b,i)},c.prototype.is_entrance=function(a,c){return this._map.at(a,c,b,"entrance")},c.prototype.is_exit=function(a,c){return this._map.at(a,c,b,"exit")},c.prototype.get_data=function(a,b){return this._map.get_stack(a,b)},c.prototype.is_blocked_in_dir=function(a,b,c){var d,e,f;return f=this.get_adjacent(a,b,c),d=f[0],e=f[1],this.is_blocked(d,e)},c.prototype.is_creature_in_dir=function(a,b,c){var d,e,f;return f=this.get_adjacent(a,b,c),d=f[0],e=f[1],this.is_creature(d,e)},c.prototype.monster_count=function(){var a;return a=0,this.each_monster(function(b){return a+=1}),a},c.prototype.get_by_pos=function(a,b){var c;return c=null,$.each(this._entities,function(d,e){if(e.x===a&&e.y===b)return c=e.id}),c},c.prototype.get_closest_creature=function(a,b){var c,d,e,f,g,h,i;return b==null&&(b={}),h=this.get_pos(a),e=h[0],f=h[1],g=(i=b.range)!=null?i:999,c=null,d=null,this.each_monster(function(a){return function(b){var h,i,j,k;k=a.get_pos(b),i=k[0],j=k[1],h=a.get_distance(e,f,i,j);if(h<=g&&(!c||h<d))return c=b,d=h}}(this)),c},c.prototype.find_in_direction=function(a,b,c,d){var e,f,g,h,i;h=this._offset_by_dir(c),f=h[0],g=h[1],e=0;for(;;){if(d(a,b,e))return[a,b];i=[a+f,b+g],a=i[0],b=i[1],e+=1}},c.prototype.pos_in_direction=function(a,b,c,d){var e,f,g;return d==null&&(d=1),g=this._offset_by_dir(c),e=g[0],f=g[1],[a+e*d,b+f*d]},c.prototype.get_distance=function(a,b,c,d){return Math.abs(c-a)+Math.abs(d-b)},c.prototype.get_adjacent_pos=function(a,b){var c,d,e;return e=this.get_pos(a),c=e[0],d=e[1],this.get_adjacent(c,d,b)},c.prototype.get_adjacent=function(a,b,c){var d,e,f;return f=this._offset_by_dir(c),d=f[0],e=f[1],[a+d,b+e]},c.prototype.get_all_adjacent_pos=function(a,b){var c;return c=[],$.each([-1,0,1],function(d){return function(d,e){return $.each([-1,0,1],function(d,f){if(e!==0||f!==0)return c.push([a+e,b+f])})}}(this)),c},c.prototype.get_adjacent_positions=function(a){return this.get_all_adjacent_pos.apply(this,this.get_pos(a))},c.prototype.general_direction=function(a,b,c){var d,e,f;return f=this.get_pos(a),d=f[0],e=f[1],this._dir_by_offset(b-d,c-e)},c.prototype.rotate_right=function(a){return g[a]},c.prototype.rotate_left=function(a){return d[a]},c.prototype.flip_dir=function(a){return f[a]},c.prototype.random_empty_space=function(){return this._random_space(function(a){return function(b,c){return!a.is_blocked(b,c)}}(this))},c.prototype.msg=function(a,b){var c;if(a===this.player_id)return c=this.output.length-(e-1),c>0&&(this.output=this.output.slice(c)),this.output.push(b)},c.prototype.shout_by=function(a,b){if(a===this.player_id)return;return this.msg(this.player_id,b)},c.prototype.set_pos=function(b,c,d){var e,f,g;return g=this._entities[b].pos(),e=g[0],f=g[1],this._map.clear_tile(e,f,a),this._entities[b].set_pos(c,d),this._map.set_tile(c,d,a,this._entities[b])},c.prototype.damage=function(a,b){var c;c=this._entities[a],c.hp-=b;if(c.hp<=0)return c.hp=0,c.dead=!0},c.prototype.remove_mp=function(a,b){var c;c=this._entities[a],c.mp-=b;if(c.mp<=0)return c.mp=0},c.prototype.remove=function(b){var c,d,e;return e=this._entities[b].pos(),c=e[0],d=e[1],delete this._entities[b],this._map.clear_tile(c,d,a)},c.prototype.set_off_triggers=function(a){var b,c,d,e;e=this.get_pos(a),b=e[0],c=e[1],d=this.get_trigger(b,c);if(d)return d(a)},c.prototype.give_skill=function(a,b){var c;return c=this._entities[a],c.add_skill(b)},c.prototype.unlock_exit=function(){return this.exit_locked=!1},c.prototype.restore_hp=function(a,b){var c;c=this._entities[a],c.hp+=b;if(c.hp>c.max_hp)return c.hp=c.max_hp},c.prototype.restore_mp=function(a,b){var c;c=this._entities[a],c.mp+=b;if(c.mp>c.max_mp)return c.mp=c.max_mp},c.prototype.grant_xp=function(a,b){var c;c=this._entities[a],c.xp+=b;if(c.xp>=1)return c.level_up(),this.msg(a,"You leveled up!")},c.prototype._add=function(a){return this._entities[a.id]=a,a.id},c.prototype._random_space=function(a){var b;return b=this._find_spaces(a),$(b).random_element()},c.prototype._find_spaces=function(a){var b;return a==null&&(a=function(){return!0}),b=[],this._map.each(function(c){return function(c,d){if(a(c,d))return b.push([c,d])}}(this)),b},c.prototype._offset_by_dir=function(a){switch(a){case"n":return[-1,0];case"ne":return[-1,1];case"e":return[0,1];case"se":return[1,1];case"s":return[1,0];case"sw":return[1,-1];case"w":return[0,-1];case"nw":return[-1,-1];default:throw new Error("Unrecognized direction: "+a)}},c.prototype._dir_by_offset=function(a,b){var c,d;return a>0?d="s":a===0?d="":d="n",b>0?c="e":b===0?c="":c="w",""+d+c},c}(),j.GameState=c,j.FLOORS=b,j.WALLS=i,j.CREATURES=a,j.TRIGGERS=h}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b.Status=a}.call(this),function(){var a,b,c=[].slice;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){this.state=new GameState(84,24),this.update_callbacks=[],this.scheduler=new ROT.Scheduler.Action,this.engine=new ROT.Engine(this.scheduler)}return a.prototype.on_key=function(){var a,b,d;a=1<=arguments.length?c.call(arguments,0):[];if(this.menu)return(b=this.menu).on_key.apply(b,a);if(this.player_actor)return(d=this.player_actor).on_key.apply(d,a)},a.prototype.start=function(){return this.prompt_character()},a.prototype.prompt_character=function(){return this.prompt_gender(function(a){return function(b){return a.prompt_race(function(c){return a.prompt_class(function(d){return a.create_player(b,c,d),a.new_floor()})})}}(this))},a.prototype.prompt_gender=function(a){return this.show_menu(new Menu("Choose your gender: ",list_genders(),function(b){return function(c){return b.show_menu(null),a(c)}}(this)))},a.prototype.prompt_race=function(a){return this.show_menu(new Menu("Choose your race: ",list_races(),function(b){return function(c){return b.show_menu(null),a(c)}}(this)))},a.prototype.prompt_class=function(a){return this.show_menu(new Menu("Choose your class: ",list_classes(),function(b){return function(c){return b.show_menu(null),a(c)}}(this)))},a.prototype.show_menu=function(a){return this.menu=a,this.update()},a.prototype.create_player=function(a,b,c){var d;return this.player_id=this.state.generate_player(a,b,c),d=get_actor("player"),this.player_actor=new d(this.player_id,this.scheduler,this.engine,this.state,function(a){return function(){return a.update()}}(this)),this.scheduler.add(this.player_actor,!0,0),this.state.register_actor(this.player_id,this.player_actor),this.player_actor.on_remove(function(a){return function(){return a.state.msg(a.player_id,"GAME OVER!"),a.update(),a.scheduler.clear(),a.state.unregister_actor(a.player_id),a.player_actor=null}}(this)),this.engine.start()},a.prototype.on_update=function(a){return this.update_callbacks.push(a),a()},a.prototype.update=function(){return $.each(this.update_callbacks,function(){return this()})},a.prototype.new_floor=function(){var a,b,c,d;return this.state.next_floor(),this.state.generate_cave(),c=this.state.random_empty_space(),a=c[0],b=c[1],this.state.add_entrance(a,b),this.state.set_pos(this.player_id,a,b),$(15).times(function(a){return function(){return a._generate_trash()}}(this)),$(5).times(function(a){return function(){return a._generate_uncommon()}}(this)),$(1).times(function(a){return function(){return a._generate_boss()}}(this)),d=this.state.random_empty_space(),a=d[0],b=d[1],this.state.add_exit(a,b),this.state.add_trigger(a,b,function(a){return function(b){if(b===a.state.player_id)return a.state.exit_locked?a.state.msg(a.player_id,"The exit is locked. You must find and defeat the boss of this level to proceed."):a.new_floor()}}(this)),this.map_ready=!0,this.update()},a.prototype._generate_trash=function(){var a,b,c,d;return a=this.state.generate_monster("trash"),this._make_actor(a,function(a){return function(){return a._surge(.12),a._grant_xp(.06),a._check_full_surge(),a.update()}}(this)),d=this.state.random_empty_space(),b=d[0],c=d[1],this.state.set_pos(a,b,c)},a.prototype._generate_uncommon=function(){var a,b,c,d;return a=this.state.generate_monster("uncommon"),this._make_actor(a,function(a){return function(){return a._surge(.4),a._grant_xp(.2),a._check_full_surge(),a.update()}}(this)),d=this.state.random_empty_space(),b=d[0],c=d[1],this.state.set_pos(a,b,c)},a.prototype._generate_boss=function(){var a,b,c,d;return a=this.state.generate_monster("rare"),this._make_actor(a,function(a){return function(){return a._surge(1),a._grant_xp(1),a._check_full_surge(),a._grant_skill(),a.state.unlock_exit(),a.state.msg(a.player_id,"You hear a clicking sound in the distance. (You may now exit this floor.)"),a.update()}}(this)),d=this.state.random_empty_space(),b=d[0],c=d[1],this.state.set_pos(a,b,c)},a.prototype._grant_skill=function(){var a,b,c,d,e;e=this.state.get_skills(this.player_id),a=list_skill_keys(),d={},_.each(e,function(a){return d[a.key]=!0}),c=[],_.each(a,function(a){if(!d[a])return c.push(a)});if(c.length===0)return;return b=$(c).random_element(),this.state.msg(this.player_id,"You learn "+b+"!"),this.state.give_skill(this.player_id,b)},a.prototype._surge=function(a){var b;if(Math.random()<a)return b=Math.random(),b<.4?this._health_surge():b<.8?this._magic_surge():(this._health_surge(),this._magic_surge());return},a.prototype._check_full_surge=function(){if(this.state.monster_count()===0)return this._full_surge()},a.prototype._full_surge=function(){return this.state.restore_hp(this.player_id,this.state.get_max_hp(this.player_id)),this.state.restore_mp(this.player_id,this.state.get_max_mp(this.player_id)),this.state.msg(this.player_id,"With all the enemies vanquished, you are able to rest. Health and magic restored.")},a.prototype._health_surge=function(){return this.state.restore_hp(this.player_id,10),this.state.msg(this.player_id,"You feel a surge of healing energy.")},a.prototype._magic_surge=function(){return this.state.restore_mp(this.player_id,10),this.state.msg(this.player_id,"You feel a surge of magic energy.")},a.prototype._grant_xp=function(a){return this.state.grant_xp(this.player_id,a)},a.prototype._make_actor=function(a,b){var c,d;return b==null&&(b=function(){}),c=get_actor("aggressive"),d=new c(a,this.scheduler,this.engine,this.state),this.scheduler.add(d,!0,0),this.state.register_actor(a,d),d.on_remove(function(c){return function(){return c.scheduler.remove(d),c.state.unregister_actor(a),b()}}(this))},a}(),b.Game=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c){this.parent=a,this.overlay=b,this.game=c}return a.prototype.update=function(){var a,b,c;b=this.game.state,a=b._player;if(!a||b.exists(a.id)){this.parent.html(""),this.parent.hide(),this.overlay.hide();return}return this.parent.show(),this.overlay.show(),c="<div class='title'>REST IN PEACE</div><div class='content'>"+("You were a <b>"+a.race.name+" "+a["class"].name+"</b>.<br /><br />")+("Your corpse decorates Floor <b>"+b.floor+"</b>.<br /><br />")+("You were level <b>"+a.level+"</b>.<br />")+("You knew <b>"+a.skills.length+"</b> skills.<br />")+"<br />"+"<br />"+"<br />"+"<a href='#' id='restart_link'>RESTART</a>","</div>",this.parent.html(c),$("#restart_link").click(function(a){return function(){return location.reload()}}(this))},a}(),b.GameOverPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){this.game=a,this.map_presenter=new MapPresenter($("#map"),this.game),this.help_presenter=new HelpPresenter($("#help"),this.game),this.skills_presenter=new SkillsPresenter($("#skills"),this.game),this.output_presenter=new OutputPresenter($("#output"),this.game),this.status_presenter=new StatusPresenter($("#status"),this.game),this.menu_presenter=new MenuPresenter($("#menu"),$("#menu_title"),$("#menu_content"),$("#menu_overlay"),this.game),this.game_over_presenter=new GameOverPresenter($("#game_over"),$("#game_over_overlay"),this.game)}return a.prototype.update=function(){return this.map_presenter.update(),this.skills_presenter.update(),this.output_presenter.update(),this.status_presenter.update(),this.menu_presenter.update(),this.game_over_presenter.update()},a}(),b.GamePresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b,this.one_time=!1,this.parent.html("Move: <br />&nbsp;&nbsp;* <b>arrow keys</b><br />&nbsp;&nbsp;* <b>num pad</b><br />&nbsp;&nbsp;* <b>hjkl</b> and <b>yubn</b><br /><br />Wait: <br />&nbsp;&nbsp;* <b>space</b><br /><br />Skills: <br />&nbsp;&nbsp;* <b>1-9</b> and <b>0</b><br /><br />GOALS:<br />&nbsp;&nbsp;* <b>kill the boss</b> to proceed<br />&nbsp;&nbsp;&nbsp;&nbsp;and <b>learn skills</b><br />&nbsp;&nbsp;* enemies may grant <b>healing</b><br />&nbsp;&nbsp;* clear level for <b>full heal</b>")}return a}(),b.HelpPresenter=a}.call(this),function(){var a,b,c,d,e,f;f=typeof exports!="undefined"&&exports!==null?exports:this,c={empty:{rep:" ",color:[0,0,0]},floor:{rep:".",color:[51,51,51]},entrance:{rep:"<",color:[80,80,80]},exit:{rep:">",color:[0,255,255]}},e={wall:{rep:"#",color:[102,102,102]}},b={player:"@",angel:"a",catfolk:"c",centaur:"C",demon:"d",dragon:"D",dragonkin:"k",dwarf:"w",elf:"e",gnome:"g",giant:"G",hobbit:"i",human:"h",shapeshifter:"s",werewolf:"w"},a={player:[255,255,255],trash:[80,80,50],uncommon:[80,50,255],rare:[255,0,0]},d=function(){function d(a,b){this.parent=a,this.data_parent=b,this.display=new ROT.Display(1,3,{width:1,height:1}),this.parent.append(this.display.getContainer()),this.state=this.data_parent.state,this.display.setOptions({width:this.state.map_width,height:this.state.map_height,fontSize:14,fontFamily:"monospace",bg:"#000000",layout:"rect"})}return d.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(!this.data_parent.map_ready){this.parent.hide();return}l=this.data_parent.state,this.parent.show(),this.display.clear(),e={},c={},f=function(a){return function(b,c){return!a.state.is_wall(b,c)}}(this),j=l.player_id;if(!this.state.exists(j))return;return m=l.get_pos(j),h=m[0],i=m[1],b=new ROT.FOV.PreciseShadowcasting(f,{topology:8}),b.compute(h,i,24,function(a,b,d,e){return c[""+a+","+b]=e}),k=function(a){return function(b,c){return a.state.is_wall(b,c)?0:1}}(this),d=new ROT.FOV.PreciseShadowcasting(f,{topology:4}),g=new ROT.Lighting(k,{range:4,passes:1}),g.setFOV(d),g.setLight(h,i,[255,255,255]),g.compute(function(a,b,c){return e[""+a+","+b]=c}),a=[200,200,200],$.each(c,function(b){return function(d){var f,g,h,i,j,k,l,m,n,o,p;p=d.split(","),n=p[0],o=p[1],h=parseInt(n),i=parseInt(o),k=b.convert(b.state.get_data(h,i)),f=k.color,j=a,e[""+h+","+i]&&(j=ROT.Color.add(j,e[""+h+","+i])),g=ROT.Color.multiply(f,j);if(c[""+h+","+i])return l=c[""+h+","+i],m=ROT.Color.multiply(g,[255*l,255*l,255*l]),b.display.draw(i,h,k.rep,ROT.Color.toRGB(m))}}(this))},d.prototype.convert=function(d){var f,g,h,i;i=c.empty;if(d[FLOORS]){i=c[d[FLOORS]];if(!i)throw new Error("Could not find rep for '"+d[FLOORS]+"'")}if(d[WALLS]){i=e[d[WALLS]];if(!i)throw new Error("Could not find rep for '"+d[WALLS]+"'")}if(d[CREATURES]){f=d[CREATURES],g=f.id===this.state.player_id,h=g?"player":f.race.key,i={rep:b[h],color:a[f.rarity]};if(!i.rep||!i.color)throw new Error("Could not find rep for '"+h+"'")}return i},d}(),f.MapPresenter=d}.call(this),function(){var a,b,c=[].slice;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c,d,e){this.parent=a,this.title=b,this.content=c,this.overlay=d,this.menu_parent=e}return a.prototype.update=function(){var a;return a=this.menu_parent.menu,a?(this.show_menu(!0),this.title.html(a.title),this.content.html(this.make_choices(a,a.choices))):this.show_menu(!1)},a.prototype.show_menu=function(a){return a==null&&(a=!0),a?($(this.parent).show(),$(this.overlay).show()):($(this.parent).hide(),$(this.overlay).hide())},a.prototype.make_choices=function(a,b){var d;return d=[],$.each(b,function(b){return function(e,f){return d.push(b.make_choice.apply(b,[a].concat(c.call(f))))}}(this)),d},a.prototype.make_choice=function(a,b,c){var d,e;return e=$("<div/>",{"class":"menu_option"}),e.html(""+b+": "),d=$("<a/>",{href:"#"}).html(c.name),d.click(function(){return a.choose(b)}),e.append(d)},a}(),b.MenuPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b}return a.prototype.update=function(){var a,b;return b=this.game.state,a=b.output,this.parent.html(""),$.each(a,function(a){return function(b,c){return a.parent.append($("<div/>",{"class":"entry"}).html(c))}}(this)),this.parent.scrollTop(this.parent[0].scrollHeight)},a}(),b.OutputPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b,this.skills=[],this.skill_costs=[],$(10).times(function(a){return function(b){var c,d,e,f;return c=$("<span/>",{"class":"cost"}),c.append(" ("),e=$("<span/>",{id:"skill_"+b+"_cost"}).html("0 mp"),c.append(e),c.append(")"),d=$("<div />",{"class":"skill"}),d.append(""+(b+1)%10+": "),f=$("<span/>",{id:"skill_"+b,"class":"disabled"}).html("none"),d.append(f),d.append(c),a.parent.append(d),a.skills.push(f),a.skill_costs.push(e)}}(this))}return a.prototype.update=function(){var a,b,c;c=this.game.state,a=c._player;if(!a)return;return b=a.skills,$(10).times(function(c){return function(d){var e;return e=b[d],e?(c.skills[d].removeClass("disabled"),c.skills[d].html(e.name),e.mp>a.mp?c.skill_costs[d].addClass("invalid"):c.skill_costs[d].removeClass("invalid"),c.skill_costs[d].html(""+e.mp+" mp")):(c.skills[d].addClass("disabled"),c.skills[d].html("none"),c.skill_costs[d].removeClass("invalid"),c.skill_costs[d].html("0 mp"))}}(this))},a.prototype._present_skill=function(a,b,c){return c?c.mp>a.mp?"<span class='disabled'>"+b+": "+c.name+"</span> (<span class='invalid'>"+c.mp+" mp</span>)":"<b>"+b+"</b>: <b>"+c.name+"</b> ("+c.mp+" mp)":"<span class='disabled'>"+b+": none</span>"},a}(),b.SkillsPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b,this.level=$("<span/>",{id:"level"}).append("0"),this.race=$("<span/>",{id:"race"}).append(""),this["class"]=$("<span/>",{id:"class"}).append("unknown"),this.parent.append("Lvl ").append(this.level).append(" ").append(this.race).append(" ").append(this["class"]).append("<br /><br />"),this.hp=$("<b/>",{id:"hp"}).html("0 / 0"),this.hp_bar=$("<b/>",{id:"hp_bar"}),this.parent.append("HP: ").append(this.hp).append(" ").append(this.hp_bar).append("<br />"),this.mp=$("<b/>",{id:"mp"}).html("0 / 0"),this.mp_bar=$("<b/>",{id:"mp_bar"}),this.parent.append("MP: ").append(this.mp).append(" ").append(this.mp_bar).append("<br />"),this.xp=$("<b/>",{id:"xp"}).html("0%"),this.xp_bar=$("<b/>",{id:"xp_bar"}),this.parent.append("XP: ").append(this.xp).append(" ").append(this.xp_bar).append("<br /><br />"),this.floor=$("<span/>",{id:"floor"}).html(0),this.enemies=$("<span/>",{id:"enemies"}).html(0),this.parent.append("FLOOR ").append(this.floor).append("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enemies: ").append(this.enemies)}return a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j;i=this.game.state,h=i._player;if(!h)return;return this.level.html(h.level),this.race.html(h.race.name),this["class"].html(h["class"].name),j=_.str.numberFormat(h.xp*100,0),g=this._nbsp_pad(""+j+"%",10),this.xp.html(g),this.xp_bar.html(this._bar("xp",h.xp,15)),a=h.hp/h.max_hp,b=""+h.hp+" / "+h.max_hp,e=this._nbsp_pad(b,10),this.hp.html(e),this.hp_bar.html(this._bar("hp",a,15)),c=h.mp/h.max_mp,d=""+h.mp+" / "+h.max_mp,f=this._nbsp_pad(d,10),this.mp.html(f),this.mp_bar.html(this._bar("mp",c,15)),this.floor.html(i.floor),this.enemies.html(i.monster_count())},a.prototype._nbsp_pad=function(a,b){return _.str.rpad(a,b,"&").replace(/&/g,"&nbsp;")},a.prototype._bar=function(a,b,c){var d,e,f,g;return e=Math.round(b*(c-2)),f=c-2-e,d=_.str.repeat("=",e),g=_.str.repeat("-",f),"<span class='bar "+a+"'><span class='filled'>|"+d+"<span class='empty'>"+g+"</span>|</span></span>"},a}(),b.StatusPresenter=a}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k;k=typeof exports!="undefined"&&exports!==null?exports:this,e=function(){var a;return a=$("<div/>",{id:"map","class":"map_content"}),$("<div/>",{"class":"map"}).append(a)},j=function(){var a,b;return b=$("<div/>",{"class":"title"}).html("status"),a=$("<div/>",{id:"status","class":"content"}),$("<div/>",{"class":"status"}).append(b).append(a)},c=function(){var a,b;return b=$("<div/>",{"class":"title"}).html("help"),a=$("<div/>",{id:"help","class":"content"}),$("<div/>",{"class":"help"}).append(b).append(a)},i=function(){var a,b;return b=$("<div/>",{"class":"title"}).html("skills"),a=$("<div/>",{id:"skills","class":"content"}),$("<div/>",{"class":"skills"}).append(b).append(a)},h=function(){var a,b;return b=$("<div/>",{"class":"title"}).html("output"),a=$("<div/>",{id:"output","class":"content"}),$("<div/>",{"class":"output"}).append(b).append(a)},f=function(){var a,b;return b=$("<div/>",{id:"menu_title","class":"title"}).html(""),a=$("<div/>",{id:"menu_content","class":"content"}),$("<div/>",{id:"menu","class":"menu"}).append(b).append(a)},g=function(){return $("<div/>",{id:"menu_overlay","class":"overlay"})},a=function(){return $("<div/>",{id:"game_over"})},b=function(){return $("<div/>",{id:"game_over_overlay","class":"overlay"})},d=function(){var d;return d=$("#game"),$(d).append(e()),$(d).append(j()),$(d).append(c()),$(d).append(i()),$(d).append(h()),$(d).append(g()),$(d).append(f()),$(d).append(a()),$(d).append(b())},k.create_layout=d}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=null,$(document).ready(function(){var b,c;return create_layout(),a=new Keyboard($("#game")),b=new Game,c=new GamePresenter(b),b.on_update(function(){return c.update()}),a.set_target(b),b.start()})}.call(this),function(){}.call(this)